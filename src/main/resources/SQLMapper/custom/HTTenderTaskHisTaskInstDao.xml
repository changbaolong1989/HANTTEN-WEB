<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hd.manager.dao.HTTenderTaskHisTaskInstDao">


    <resultMap id="selectList" type="com.hd.manager.dao.bean.HTTenderTaskHisTaskInstBean">
        <id column="parentTaskKey" property="taskKey" />
        <collection property="HTTenderTaskHisTaskInstBeanList" ofType="com.hd.manager.dao.bean.HTTenderTaskHisTaskInstBean">
            <id column="historyId" property="historyId" />
            <result column="tenderTaskId" property="tenderTaskId" />
            <result column="processInstId" property="processInstId" />
            <result column="taskKey" property="taskKey" />
            <result column="isPass" property="isPass" />
            <result column="rejectReason" property="rejectReason" />
            <result column="approveUserId" property="approveUserId" />
            <result column="signPath" property="signPath" />
            <result column="approveUserName" property="approveUserName" />
            <result column="approveTime" property="approveTime" />
            <collection property="htUserQuestionRecordRelationBeanList" ofType="com.hd.manager.dao.bean.HTUserQuestionRecordRelationBean">
                <id column="childRelationId" property="relationId"></id>
                <result column="childRecordId" property="recordId"></result>
                <result column="childUserId" property="userId"></result>
                <result column="childUserName" property="userName"></result>
                <result column="childQuestionId" property="questionId"></result>
                <result column="childQuestionName" property="questionName"></result>
                <result column="childQuestionNum" property="questionNum"></result>
                <result column="childSourceType" property="sourceType"></result>
            </collection>
        </collection>
    </resultMap>

    <!--查询流程列表-->
    <select id="excSearchHTTenderTaskHisTaskInstList"
            resultType="com.hd.manager.dao.bean.HTTenderTaskHisTaskInstBean">
        SELECT
            history_id        AS  historyId,
            tender_task_id    AS  tenderTaskId,
            process_inst_id   AS  processInstId,
            task_key          AS  taskKey,
            is_pass           AS  isPass,
            reject_reason     AS  rejectReason,
            approve_user_id   AS  approveUserId,
            approve_time      AS  approveTime

        FROM
            tb_tender_task_his_taskinst tttht
        WHERE
            tttht.tender_task_id = #{tenderTaskId}
        AND
            tttht.task_key = #{taskKey}
        ORDER BY
            tttht.approve_time asc
    </select>

    <!--查询当前投标任务进度-->
    <select id="excSearchTaskKeysByTenderTaskId"
            resultType="com.hd.manager.dao.bean.HTTenderTaskHisTaskInstBean">
        SELECT
            task_key AS  taskKey
        FROM
            tb_tender_task_his_taskinst tttht
        WHERE
            tttht.tender_task_id = #{tenderTaskId}
        GROUP BY
            tttht.task_key
    </select>

    <!--查询投标任务历史流程(审核记录)-->
    <select id="excSearchHTTenderTaskHisTaskInstInfoList" resultMap="selectList">
        SELECT
            tttht.task_key           AS  parentTaskKey,
            tttht.history_id         AS  historyId,
            tttht.tender_task_id     AS  tenderTaskId,
            tttht.process_inst_id    AS  processInstId,
            tttht.task_key           AS  taskKey,
            tttht.is_pass            AS  isPass,
            tttht.reject_reason      AS  rejectReason,
            tttht.approve_user_id    AS  approveUserId,
            ptu.user_name            AS  approveUserName,
            ptu.sign_path            AS  signPath,
            tttht.approve_time       AS  approveTime,
            tuqrr.relation_id		 AS  childRelationId,
            tuqrr.record_id			 AS  childRecordId,
            tuqrr.user_id			 AS  childUserId,
            tu.user_name			 AS  childUserName,
            tuqrr.question_id		 AS  childQuestionId,
            tdq.question_name		 AS  childQuestionName,
            tuqrr.question_num	     AS  childQuestionNum,
            tuqrr.source_type		 AS  childSourceType

        FROM
            tb_tender_task_his_task_inst tttht
        LEFT JOIN
            (SELECT * FROM tb_user_question_record_relation WHERE source_type = '2') tuqrr
        ON
            tuqrr.record_id = tttht.history_id
        LEFT JOIN
            tb_user tu
        ON
            tu.user_id = tuqrr.user_id
        LEFT JOIN
            tb_user ptu
        ON
            ptu.user_id = tttht.approve_user_id
        LEFT JOIN
            tb_dict_question tdq
        ON
            tdq.question_id = tuqrr.question_id
        WHERE
            tttht.tender_task_id = #{tenderTaskId}
        order by
            tttht.approve_time asc
    </select>
</mapper>
